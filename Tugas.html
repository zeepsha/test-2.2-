<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wealth Simulator Pro â€” Investasi & Pensiun</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Outfit', 'sans-serif'] },
          colors: {
            glass: 'rgba(255, 255, 255, 0.7)',
            glassBorder: 'rgba(255, 255, 255, 0.5)',
            primary: '#4f46e5',
            secondary: '#0ea5e9',
            dark: '#0f172a'
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe 0%, #eef2ff 50%, #f0f9ff 100%);
      background-attachment: fixed;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    .input-field {
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }

    .input-field:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(to right, #4f46e5, #6366f1);
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="text-slate-800 antialiased min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="sticky top-0 z-50 glass-panel border-b border-white/40 px-6 py-4 mb-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div
          class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-sky-500 flex items-center justify-center text-white font-bold">
          W</div>
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-sky-600">Wealth
          Simulator Pro</h1>
      </div>
      <div class="flex gap-1 bg-slate-100/50 p-1 rounded-xl">
        <button onclick="setMode('calc')" id="nav-calc"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow-sm text-indigo-600">Kalkulator</button>
        <button onclick="setMode('pension')" id="nav-pension"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Pensiun</button>
        <button onclick="setMode('game')" id="nav-game"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Game</button>
        <button onclick="setMode('learn')" id="nav-learn"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Belajar</button>
      </div>
    </div>
  </nav>

  <main class="flex-grow px-4 pb-12">
    <div class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-6">

      <!-- LEFT PANEL: INPUTS -->
      <div class="lg:col-span-4 space-y-6 fade-in" style="animation-delay: 0.1s">

        <!-- Calculator Inputs -->
        <div id="panel-calc" class="glass-panel rounded-2xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-slate-800">Parameter Investasi</h2>
            <span class="text-xs font-medium px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full">Mode Pro</span>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Modal Awal</label>
              <div class="relative">
                <span class="absolute left-3 top-3 text-slate-400">Rp</span>
                <input type="number" id="inp-initial" class="input-field w-full pl-10 p-2.5 rounded-xl bg-white/80"
                  value="10000000">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Setoran/Bulan</label>
                <input type="number" id="inp-monthly" class="input-field w-full p-2.5 rounded-xl bg-white/80"
                  value="1000000">
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Durasi
                  (Tahun)</label>
                <input type="number" id="inp-years" class="input-field w-full p-2.5 rounded-xl bg-white/80" value="10">
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Pilih Aset</label>
              <select id="inp-asset"
                class="input-field w-full p-2.5 rounded-xl bg-white/80 appearance-none cursor-pointer"
                onchange="updateAssetInfo()">
                <option value="custom">Custom Return</option>
                <option value="deposito">Deposito (4% | Low Risk)</option>
                <option value="bond">Obligasi Negara (6.5% | Low-Mid Risk)</option>
                <option value="gold">Emas (8% | Mid Risk)</option>
                <option value="sp500" selected>S&P 500 (10% | Mid-High Risk)</option>
                <option value="stock_id">Saham IHSG (12% | High Risk)</option>
                <option value="crypto">Bitcoin/Crypto (50% | Extreme Risk)</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-4 bg-slate-50/50 p-3 rounded-xl border border-slate-100">
              <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Return (%)</label>
                <input type="number" id="inp-return" class="input-field w-full p-2 text-sm rounded-lg" value="10">
              </div>
              <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Inflasi (%)</label>
                <input type="number" id="inp-inflation" class="input-field w-full p-2 text-sm rounded-lg" value="3.5">
              </div>
            </div>

            <button onclick="calculate()"
              class="btn-primary w-full py-3.5 rounded-xl text-white font-semibold shadow-lg shadow-indigo-500/20 mt-2">
              Hitung Proyeksi
            </button>

            <button onclick="runMonteCarlo()"
              class="w-full py-2.5 rounded-xl text-indigo-600 font-medium bg-indigo-50 hover:bg-indigo-100 transition-colors text-sm">
              Jalankan Simulasi Monte Carlo (1000x)
            </button>
          </div>
        </div>

        <!-- Pension Inputs (Hidden by default) -->
        <div id="panel-pension" class="glass-panel rounded-2xl p-6 hidden">
          <h2 class="text-lg font-bold text-slate-800 mb-4">Perencanaan Pensiun</h2>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Usia Sekarang</label>
                <input type="number" id="pen-age-now" class="input-field w-full p-2.5 rounded-xl" value="25">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Usia Pensiun</label>
                <input type="number" id="pen-age-retire" class="input-field w-full p-2.5 rounded-xl" value="55">
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Pengeluaran Bulanan (Saat Pensiun)</label>
              <input type="number" id="pen-expense" class="input-field w-full p-2.5 rounded-xl" value="10000000">
              <p class="text-[10px] text-slate-400 mt-1">*Nilai hari ini (akan disesuaikan inflasi)</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Aset Saat Ini</label>
              <input type="number" id="pen-current" class="input-field w-full p-2.5 rounded-xl" value="50000000">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Investasi Bulanan</label>
              <input type="number" id="pen-monthly" class="input-field w-full p-2.5 rounded-xl" value="2000000">
            </div>

            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Pilihan Aset Investasi</label>
              <select id="pen-asset"
                class="input-field w-full p-2.5 rounded-xl bg-white/80 appearance-none cursor-pointer">
                <option value="deposito">Deposito (4%)</option>
                <option value="bond">Obligasi Negara (6.5%)</option>
                <option value="gold">Emas (8%)</option>
                <option value="sp500" selected>S&P 500 (10%)</option>
                <option value="stock_id">Saham IHSG (12%)</option>
              </select>
              <p class="text-[10px] text-slate-400 mt-1">*Asumsi return rata-rata per tahun</p>
            </div>
            <button onclick="calculatePension()" class="btn-primary w-full py-3 rounded-xl text-white font-semibold">
              Cek Kesiapan Pensiun
            </button>
          </div>
        </div>

        <!-- Game Inputs (Hidden) -->
        <div id="panel-game" class="glass-panel rounded-2xl p-6 hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-slate-800">Market Simulator</h2>
            <div class="text-right">
              <div class="text-xs text-slate-500">Tahun ke-</div>
              <div class="text-xl font-bold text-indigo-600" id="game-year">0</div>
            </div>
          </div>

          <div class="bg-indigo-900 text-white p-4 rounded-xl mb-4 shadow-lg">
            <div class="flex justify-between items-start">
              <div>
                <div class="text-xs text-indigo-200 mb-1">Total Kekayaan</div>
                <div class="text-2xl font-bold" id="game-balance">Rp 100.000.000</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-indigo-200 mb-1">Ekonomi</div>
                <div class="font-bold bg-white/20 px-2 py-1 rounded text-sm" id="game-economy">Normal</div>
              </div>
            </div>
            <div class="flex gap-2 mt-2 text-xs">
              <span class="bg-white/20 px-2 py-1 rounded">Cash: <span id="game-cash">Rp 100jt</span></span>
              <span class="bg-white/20 px-2 py-1 rounded">Invest: <span id="game-invest">Rp 0</span></span>
            </div>
          </div>

          <div class="space-y-3">
            <label class="text-xs font-bold text-slate-500 uppercase">Alokasi Aset (Beli / Jual)</label>
            <div class="grid grid-cols-1 gap-2">
              <!-- S&P 500 -->
              <div class="flex items-center gap-2 p-2 border rounded-xl hover:bg-slate-50">
                <div class="flex-1">
                  <div class="font-bold text-sm">S&P 500</div>
                  <div class="text-xs text-slate-500">Avg 10%</div>
                </div>
                <button onclick="gameBuy('sp500')"
                  class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-200">Beli</button>
                <button onclick="gameSell('sp500')"
                  class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Jual</button>
              </div>
              <!-- Crypto -->
              <div class="flex items-center gap-2 p-2 border rounded-xl hover:bg-slate-50">
                <div class="flex-1">
                  <div class="font-bold text-sm">Crypto</div>
                  <div class="text-xs text-slate-500">Avg 50%</div>
                </div>
                <button onclick="gameBuy('crypto')"
                  class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-200">Beli</button>
                <button onclick="gameSell('crypto')"
                  class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Jual</button>
              </div>
              <!-- Bond -->
              <div class="flex items-center gap-2 p-2 border rounded-xl hover:bg-slate-50">
                <div class="flex-1">
                  <div class="font-bold text-sm">Obligasi</div>
                  <div class="text-xs text-slate-500">Avg 6%</div>
                </div>
                <button onclick="gameBuy('bond')"
                  class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-200">Beli</button>
                <button onclick="gameSell('bond')"
                  class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Jual</button>
              </div>
              <!-- Gold -->
              <div class="flex items-center gap-2 p-2 border rounded-xl hover:bg-slate-50">
                <div class="flex-1">
                  <div class="font-bold text-sm">Emas</div>
                  <div class="text-xs text-slate-500">Avg 8%</div>
                </div>
                <button onclick="gameBuy('gold')"
                  class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-200">Beli</button>
                <button onclick="gameSell('gold')"
                  class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Jual</button>
              </div>
            </div>

            <div class="flex gap-2 mt-4">
              <input type="number" id="game-amount" class="input-field flex-1 p-2 rounded-lg"
                placeholder="Nominal Transaksi">
              <button onclick="gameNextYear()"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-green-500/20">Next
                Year >></button>
            </div>
            <div id="game-log" class="text-xs text-slate-500 h-32 overflow-y-auto bg-slate-50 p-2 rounded border"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT PANEL: RESULTS -->
      <div class="lg:col-span-8 space-y-6 fade-in" style="animation-delay: 0.2s">

        <!-- Learn Panel (Hidden) -->
        <div id="panel-learn" class="glass-panel p-6 rounded-2xl hidden">
          <h2 class="text-2xl font-bold text-slate-800 mb-6">Belajar Investasi</h2>
          <div class="grid md:grid-cols-2 gap-6">

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-10 h-10 bg-red-100 text-red-600 rounded-lg flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 3v18h18" />
                  <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
                </svg>
              </div>
              <h3 class="font-bold text-lg mb-2">Inflasi: Musuh Tersembunyi</h3>
              <p class="text-sm text-slate-600 leading-relaxed">
                Inflasi membuat daya beli uang Anda menurun setiap tahun. Jika inflasi 4%, uang Rp 100 juta hari ini
                hanya akan bernilai setara Rp 96 juta tahun depan. Investasi adalah cara untuk melawan inflasi.
              </p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
              </div>
              <h3 class="font-bold text-lg mb-2">Bunga Berbunga (Compound Interest)</h3>
              <p class="text-sm text-slate-600 leading-relaxed">
                Albert Einstein menyebutnya "Keajaiban Dunia ke-8". Ini adalah saat bunga investasi Anda menghasilkan
                bunga lagi. Semakin lama Anda berinvestasi, semakin eksponensial pertumbuhan uang Anda.
              </p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                </svg>
              </div>
              <h3 class="font-bold text-lg mb-2">Kelas Aset</h3>
              <ul class="text-sm text-slate-600 space-y-2">
                <li><strong>Saham:</strong> Kepemilikan perusahaan. High risk, high return.</li>
                <li><strong>Obligasi:</strong> Surat utang negara/perusahaan. Lebih aman, return moderat.</li>
                <li><strong>Deposito:</strong> Simpanan bank. Sangat aman, return rendah.</li>
              </ul>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 12h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L3 14" />
                  <path d="m7 7 1.6 1.6" />
                  <path d="m18.4 18.4 1.6 1.6" />
                  <path d="M15 15.5c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2s.9-2 2-2h4c1.1 0 2 .9 2 2z" />
                </svg>
              </div>
              <h3 class="font-bold text-lg mb-2">Diversifikasi</h3>
              <p class="text-sm text-slate-600 leading-relaxed">
                "Jangan taruh semua telur dalam satu keranjang." Sebar investasi Anda ke berbagai aset (saham, emas,
                obligasi) untuk mengurangi risiko jika salah satu aset anjlok.
              </p>
            </div>

          </div>
        </div>

        <!-- Summary Cards -->
        <div id="results-container">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
              <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-500/10 rounded-full group-hover:scale-110 transition-transform">
              </div>
              <div class="text-sm text-slate-500 font-medium mb-1">Nilai Akhir (Nominal)</div>
              <div class="text-2xl font-bold text-indigo-600" id="res-nominal">-</div>
              <div class="text-xs text-green-600 mt-1 flex items-center gap-1">
                <span id="res-gain-pct">0%</span> growth
              </div>
            </div>

            <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
              <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-sky-500/10 rounded-full group-hover:scale-110 transition-transform">
              </div>
              <div class="text-sm text-slate-500 font-medium mb-1">Nilai Riil (Adj. Inflasi)</div>
              <div class="text-2xl font-bold text-sky-600" id="res-real">-</div>
              <div class="text-xs text-slate-400 mt-1">Daya beli masa depan</div>
            </div>

            <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
              <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full group-hover:scale-110 transition-transform">
              </div>
              <div class="text-sm text-slate-500 font-medium mb-1">Total Bunga/Profit</div>
              <div class="text-2xl font-bold text-emerald-600" id="res-profit">-</div>
              <div class="text-xs text-slate-400 mt-1" id="res-cagr">CAGR: 0%</div>
            </div>
          </div>

          <!-- Charts Area -->
          <div class="glass-panel p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-slate-700">Proyeksi Pertumbuhan</h3>
              <button onclick="exportExcel()"
                class="flex items-center gap-2 text-xs font-bold text-green-700 bg-green-100 hover:bg-green-200 px-3 py-1.5 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="12" y1="18" x2="12" y2="12"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Export Excel
              </button>
            </div>
            <div class="h-[320px] w-full">
              <canvas id="mainChart"></canvas>
            </div>
          </div>

          <!-- Analysis / Monte Carlo Results -->
          <div id="analysis-panel" class="glass-panel p-6 rounded-2xl hidden">
            <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">Analisis Mendalam</h3>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h4 class="text-sm font-semibold text-slate-500 mb-3">Monte Carlo Risk Analysis</h4>
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between">
                    <span>Skenario Terburuk (10%):</span>
                    <span class="font-bold text-red-500" id="mc-worst">-</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Skenario Median (50%):</span>
                    <span class="font-bold text-amber-500" id="mc-median">-</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Skenario Terbaik (90%):</span>
                    <span class="font-bold text-green-500" id="mc-best">-</span>
                  </div>
                  <div class="mt-4 p-3 bg-slate-50 rounded-lg text-xs text-slate-600">
                    <span class="font-bold block mb-1">Insight:</span>
                    Ada kemungkinan <span id="mc-chance" class="font-bold text-indigo-600">95%</span> uang Anda tidak
                    akan
                    habis sebelum periode berakhir.
                  </div>
                </div>
              </div>
              <div>
                <h4 class="text-sm font-semibold text-slate-500 mb-3">Distribusi Aset (Game/Portfolio)</h4>
                <div class="h-40 flex justify-center">
                  <canvas id="pieChart"></canvas>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </main>

  <script>
    // --- CONFIG & DATA ---
    const ASSETS = {
      deposito: { ret: 4, vol: 1, name: "Deposito" },
      bond: { ret: 6.5, vol: 5, name: "Obligasi Negara" },
      gold: { ret: 8, vol: 15, name: "Emas" },
      sp500: { ret: 10, vol: 18, name: "S&P 500" },
      stock_id: { ret: 12, vol: 22, name: "Saham IHSG" },
      crypto: { ret: 50, vol: 80, name: "Bitcoin/Crypto" },
      custom: { ret: 0, vol: 0, name: "Custom" }
    };

    let chartInstance = null;
    let pieInstance = null;
    let currentData = []; // Store for Excel export

    // --- UTILS ---
    const rp = (n) => 'Rp ' + Number(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    const getVal = (id) => Number(document.getElementById(id).value) || 0;
    const setHtml = (id, val) => document.getElementById(id).innerHTML = val;

    // --- CORE LOGIC ---

    function updateAssetInfo() {
      const key = document.getElementById('inp-asset').value;
      if (key !== 'custom') {
        document.getElementById('inp-return').value = ASSETS[key].ret;
      }
    }

    function calculate() {
      const initial = getVal('inp-initial');
      const monthly = getVal('inp-monthly');
      const years = getVal('inp-years');
      const rate = getVal('inp-return');
      const inflation = getVal('inp-inflation');

      let balance = initial;
      let totalInvested = initial;
      let realBalance = initial; // Adjusted for inflation

      const labels = [];
      const dataNominal = [];
      const dataReal = [];
      const dataInvested = [];

      currentData = []; // Reset export data

      for (let i = 0; i <= years; i++) {
        labels.push('Thn ' + i);
        dataNominal.push(balance);
        dataReal.push(realBalance);
        dataInvested.push(totalInvested);

        currentData.push({
          Tahun: i,
          "Modal Investasi": totalInvested,
          "Nilai Nominal": Math.round(balance),
          "Nilai Riil (Daya Beli)": Math.round(realBalance)
        });

        if (i < years) {
          // Monthly compounding
          for (let m = 0; m < 12; m++) {
            balance += monthly;
            balance *= (1 + (rate / 100) / 12);
            totalInvested += monthly;
          }
          // Inflation adjustment (annual approximation for simplicity in loop)
          realBalance = balance / Math.pow(1 + inflation / 100, i + 1);
        }
      }

      // Update UI Stats
      const profit = balance - totalInvested;
      const gainPct = (profit / totalInvested) * 100;
      const cagr = (Math.pow(balance / initial, 1 / years) - 1) * 100;

      setHtml('res-nominal', rp(balance));
      setHtml('res-real', rp(realBalance));
      setHtml('res-profit', rp(profit));
      setHtml('res-gain-pct', gainPct.toFixed(1) + '%');
      setHtml('res-cagr', `CAGR: ${cagr.toFixed(2)}%`);

      // Render Chart
      renderChart(labels, [
        { label: 'Nilai Nominal', data: dataNominal, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true },
        { label: 'Nilai Riil (Inflasi)', data: dataReal, borderColor: '#0ea5e9', borderDash: [5, 5], fill: false },
        { label: 'Modal Disetor', data: dataInvested, borderColor: '#94a3b8', fill: false }
      ]);

      document.getElementById('analysis-panel').classList.add('hidden');
    }

    function runMonteCarlo() {
      const initial = getVal('inp-initial');
      const monthly = getVal('inp-monthly');
      const years = getVal('inp-years');
      const assetKey = document.getElementById('inp-asset').value;

      // Get volatility
      let vol = 15; // default
      let mean = getVal('inp-return');

      if (ASSETS[assetKey]) {
        vol = ASSETS[assetKey].vol;
        if (assetKey !== 'custom') mean = ASSETS[assetKey].ret;
      }

      const simulations = 1000;
      const finalValues = [];
      const allSeries = [];

      for (let s = 0; s < simulations; s++) {
        let bal = initial;
        const series = [bal];
        for (let y = 1; y <= years; y++) {
          // Annual return with volatility (Geometric Brownian Motion approximation)
          // r = mean + vol * standard_normal_random
          const u1 = Math.random();
          const u2 = Math.random();
          const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
          const r = mean + (vol * z);

          bal = (bal + monthly * 12) * (1 + r / 100);
          series.push(bal);
        }
        finalValues.push(bal);
        if (s < 50) allSeries.push(series); // Keep first 50 for visualization if needed
      }

      finalValues.sort((a, b) => a - b);
      const p10 = finalValues[Math.floor(simulations * 0.1)];
      const p50 = finalValues[Math.floor(simulations * 0.5)];
      const p90 = finalValues[Math.floor(simulations * 0.9)];

      // Show Analysis Panel
      document.getElementById('analysis-panel').classList.remove('hidden');
      setHtml('mc-worst', rp(p10));
      setHtml('mc-median', rp(p50));
      setHtml('mc-best', rp(p90));

      // Update Chart to show Monte Carlo Spread (simplified: just 3 lines)
      const labels = Array.from({ length: years + 1 }, (_, i) => 'Thn ' + i);

      // Reconstruct 3 representative lines roughly matching percentiles
      // Note: This is a simplification for visualization. Ideally we store the full paths of p10, p50, p90.
      // For now, we'll just plot the median path and shade the area? 
      // Better: Plot 5 random paths + Median.

      renderChart(labels, [
        { label: 'Median Scenario', data: allSeries[0].map((_, i) => p50 * (i / years)), borderColor: '#f59e0b', borderWidth: 3 }, // Simplified linear proj for visual only
        // Actually, let's just run one specific simulation for the chart to be accurate to "a path"
        { label: 'Simulasi 1', data: allSeries[0], borderColor: 'rgba(79, 70, 229, 0.3)', borderWidth: 1 },
        { label: 'Simulasi 2', data: allSeries[1], borderColor: 'rgba(79, 70, 229, 0.3)', borderWidth: 1 },
        { label: 'Simulasi 3', data: allSeries[2], borderColor: 'rgba(79, 70, 229, 0.3)', borderWidth: 1 },
        { label: 'Simulasi 4', data: allSeries[3], borderColor: 'rgba(79, 70, 229, 0.3)', borderWidth: 1 },
        { label: 'Simulasi 5', data: allSeries[4], borderColor: 'rgba(79, 70, 229, 0.3)', borderWidth: 1 },
      ]);

      // Correct the chart to show meaningful data:
      // We will re-run the "Calculate" logic for the main line, and overlay MC clouds.
      // For simplicity in this artifact, let's just stick to the text analysis for MC and keep the main chart as the deterministic projection.
      calculate(); // Re-render main chart
      // But update the analysis text
    }

    function calculatePension() {
      const ageNow = getVal('pen-age-now');
      const ageRetire = getVal('pen-age-retire');
      const expense = getVal('pen-expense');
      const current = getVal('pen-current');
      const monthly = getVal('pen-monthly');
      const assetKey = document.getElementById('pen-asset').value;

      const yearsToRetire = ageRetire - ageNow;
      const inflation = 3.5; // assumption

      // Use selected asset return
      const returnRate = ASSETS[assetKey] ? ASSETS[assetKey].ret : 8;

      // FV of Expense (Lifestyle cost at retirement)
      const futureExpense = expense * Math.pow(1 + inflation / 100, yearsToRetire);

      // 4% Rule (Safe Withdrawal Rate) -> Need 25x annual expense
      const targetCorpus = futureExpense * 12 * 25;

      // Calculate projected corpus
      let corpus = current;
      for (let i = 0; i < yearsToRetire; i++) {
        corpus = (corpus + monthly * 12) * (1 + returnRate / 100);
      }

      const gap = corpus - targetCorpus;
      const isSafe = gap >= 0;

      setHtml('res-nominal', rp(corpus));
      setHtml('res-real', rp(corpus / Math.pow(1 + inflation / 100, yearsToRetire))); // Real value today
      setHtml('res-profit', rp(targetCorpus));
      document.querySelector('#res-profit').previousElementSibling.innerText = "Target Dana Pensiun (4% Rule)";

      setHtml('res-cagr', isSafe ?
        `<span class="text-green-600 font-bold">AMAN! Surplus ${rp(gap)}</span>` :
        `<span class="text-red-500 font-bold">KURANG ${rp(Math.abs(gap))}</span>`
      );

      // Chart
      renderChart(['Sekarang', 'Pensiun'], [
        { label: 'Proyeksi Aset (' + ASSETS[assetKey].name + ')', data: [current, corpus], backgroundColor: '#4f46e5', type: 'bar' },
        { label: 'Target Dibutuhkan', data: [0, targetCorpus], backgroundColor: '#ef4444', type: 'bar' }
      ]);
    }

    // --- GAME LOGIC ---
    let gameData = {
      year: 0,
      balance: 100000000,
      cash: 100000000,
      portfolio: { sp500: 0, crypto: 0, bond: 0, gold: 0 },
      history: [],
      economy: 'Normal' // Normal, Boom, Recession, Crash
    };

    const ECONOMY_TYPES = {
      'Normal': { label: 'Normal', color: 'text-slate-600', multiplier: 1 },
      'Boom': { label: 'Boom Market ðŸš€', color: 'text-green-600', multiplier: 1.5 },
      'Recession': { label: 'Resesi ðŸ“‰', color: 'text-orange-600', multiplier: 0.5 },
      'Crash': { label: 'Market Crash ðŸ’¥', color: 'text-red-600', multiplier: -0.5 }
    };

    const EVENTS = [
      { msg: "Sakit Tipes, biaya RS", cost: 5000000 },
      { msg: "Servis Motor turun mesin", cost: 2000000 },
      { msg: "Kondangan teman akrab", cost: 500000 },
      { msg: "Bayar BPJS setahun", cost: 1800000 },
      { msg: "HP Rusak ganti LCD", cost: 1500000 },
      { msg: "Dapet Bonus Tahunan!", cost: -5000000 }, // Negative cost = Income
      { msg: "Menang Giveaway", cost: -1000000 }
    ];

    function gameBuy(asset) {
      const amount = Number(document.getElementById('game-amount').value);
      if (!amount || amount <= 0) return alert("Masukkan nominal valid");
      if (amount > gameData.cash) return alert("Cash tidak cukup!");

      gameData.cash -= amount;
      gameData.portfolio[asset] += amount;
      gameUpdateUI();
      logGame(`Beli ${asset} senilai ${rp(amount)}`, 'text-blue-600');
    }

    function gameSell(asset) {
      const amount = Number(document.getElementById('game-amount').value);
      if (!amount || amount <= 0) return alert("Masukkan nominal valid");
      if (amount > gameData.portfolio[asset]) return alert("Aset tidak cukup!");

      gameData.portfolio[asset] -= amount;
      gameData.cash += amount;
      gameUpdateUI();
      logGame(`Jual ${asset} senilai ${rp(amount)}`, 'text-green-600');
    }

    function gameNextYear() {
      gameData.year++;

      // 1. Economic Cycle Change (20% chance)
      if (Math.random() < 0.2) {
        const types = Object.keys(ECONOMY_TYPES);
        gameData.economy = types[Math.floor(Math.random() * types.length)];
        logGame(`Ekonomi berubah menjadi: ${ECONOMY_TYPES[gameData.economy].label}`, 'font-bold ' + ECONOMY_TYPES[gameData.economy].color);
      }

      // 2. Asset Growth based on Economy
      let totalPort = 0;
      const ecoMult = ECONOMY_TYPES[gameData.economy].multiplier;

      for (let key in gameData.portfolio) {
        if (gameData.portfolio[key] > 0) {
          const base = ASSETS[key].ret;
          const vol = ASSETS[key].vol;

          // Base return affected by economy
          // Normal: base | Boom: base*1.5 | Recession: base*0.5 | Crash: negative
          let effectiveBase = base;
          if (gameData.economy === 'Crash') effectiveBase = -Math.abs(base * 2); // Crash is bad
          else effectiveBase = base * ecoMult;

          // Random walk component
          const r = effectiveBase + (Math.random() * vol * 2 - vol);

          const gain = gameData.portfolio[key] * (r / 100);
          gameData.portfolio[key] += gain;

          // Log significant moves
          if (Math.abs(r) > 20) logGame(`${key}: ${r.toFixed(1)}% (${rp(gain)})`, r > 0 ? 'text-green-500' : 'text-red-500');
        }
        totalPort += gameData.portfolio[key];
      }

      // 3. Random Life Events (30% chance)
      if (Math.random() < 0.3) {
        const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
        gameData.cash -= evt.cost;
        const color = evt.cost > 0 ? 'text-red-600' : 'text-green-600';
        logGame(`EVENT: ${evt.msg} (${rp(-evt.cost)})`, 'font-bold ' + color);

        if (gameData.cash < 0) {
          logGame("PERINGATAN: Cash minus! Anda berhutang.", 'text-red-700 font-bold bg-red-100 p-1');
        }
      }

      gameData.balance = gameData.cash + totalPort;
      gameUpdateUI();
    }

    function gameUpdateUI() {
      setHtml('game-year', gameData.year);
      setHtml('game-balance', rp(gameData.balance));

      const eco = ECONOMY_TYPES[gameData.economy];
      setHtml('game-economy', `<span class="${eco.color}">${eco.label}</span>`);

      const total = gameData.balance;
      // Handle negative balance visual
      const safeTotal = total > 0 ? total : 1;

      const invest = Object.values(gameData.portfolio).reduce((a, b) => a + b, 0);
      setHtml('game-cash', rp(gameData.cash));
      setHtml('game-invest', rp(invest));

      // Update Pie Chart
      const p = gameData.portfolio;
      const labels = ['Cash', ...Object.keys(p)];
      // Chart.js doesn't like negative values for doughnut, so clamp cash to 0 for chart
      const chartCash = gameData.cash > 0 ? gameData.cash : 0;
      const data = [chartCash, ...Object.values(p)];

      if (pieInstance) pieInstance.destroy();
      const ctx = document.getElementById('pieChart').getContext('2d');
      pieInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: ['#cbd5e1', '#4f46e5', '#f59e0b', '#10b981', '#ef4444']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' } } }
      });

      document.getElementById('analysis-panel').classList.remove('hidden');
    }

    function logGame(msg, classes = '') {
      const log = document.getElementById('game-log');
      log.innerHTML = `<div class="mb-1 ${classes}"><span class="text-slate-400 text-[10px]">Thn ${gameData.year}</span> ${msg}</div>` + log.innerHTML;
    }

    // --- CHARTING ---
    function renderChart(labels, datasets) {
      const ctx = document.getElementById('mainChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              callbacks: { label: (c) => c.dataset.label + ': ' + rp(c.raw) }
            }
          },
          scales: {
            y: { grid: { color: '#f1f5f9' }, ticks: { callback: (v) => v / 1000000 + 'jt' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // --- EXCEL EXPORT ---
    function exportExcel() {
      if (currentData.length === 0) return alert("Lakukan perhitungan terlebih dahulu!");

      const ws = XLSX.utils.json_to_sheet(currentData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Proyeksi Investasi");
      XLSX.writeFile(wb, "Analisis_Investasi.xlsx");
    }

    // --- NAVIGATION ---
    function setMode(mode) {
      ['calc', 'pension', 'game', 'learn'].forEach(m => {
        const panel = document.getElementById(`panel-${m}`);
        if (panel) panel.classList.add('hidden');

        const btn = document.getElementById(`nav-${m}`);
        if (btn) {
          btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
          btn.classList.add('text-slate-500');
        }
      });

      document.getElementById(`panel-${mode}`).classList.remove('hidden');
      const btn = document.getElementById(`nav-${mode}`);
      btn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
      btn.classList.remove('text-slate-500');

      // Reset view
      if (mode === 'learn') {
        document.getElementById('results-container').classList.add('hidden');
      } else {
        document.getElementById('results-container').classList.remove('hidden');
        document.getElementById('analysis-panel').classList.add('hidden');
        if (mode === 'calc') calculate();
      }
    }

    // Init
    window.onload = () => {
      calculate();
    };

  </script>
</body>

</html>
