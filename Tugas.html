<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulator Investasi ‚Äî Pensiun, Monte Carlo, Animasi (Fixed Final)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family: Inter, system-ui, Arial, sans-serif}
    .glass{background: rgba(255,255,255,0.6); backdrop-filter: blur(8px);} 
    .card{transition:transform .18s, box-shadow .18s; border-radius:16px;} 
    .card:hover{transform:translateY(-4px); box-shadow:0 14px 40px rgba(2,6,23,.12);} 
    .fade{animation:fadeIn .28s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .scale{transition:transform .12s ease;}.scale:active{transform:scale(.98)}
    .small{font-size:.86rem}
  </style>
</head>
<body class="bg-gradient-to-br from-sky-200 to-indigo-500 min-h-screen p-8">
  <div class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-6">

    <!-- LEFT PANEL -->
    <section class="glass p-6 shadow-lg card fade">
      <h1 class="text-2xl font-bold mb-4">üí∞ Simulator Investasi</h1>

      <div class="grid grid-cols-3 gap-2 mb-4">
        <button id="btnCalc" class="py-2 bg-indigo-600 text-white rounded-lg scale">Kalkulator</button>
        <button id="btnGame" class="py-2 bg-white text-gray-800 rounded-lg scale">Game</button>
        <button id="btnChallenge" class="py-2 bg-white text-gray-800 rounded-lg scale">Challenge</button>
      </div>

      <label class="text-sm font-semibold">Aset</label>
      <select id="asset" class="w-full p-3 rounded-lg mb-4 border">
        <option value="gold">Emas (8%)</option>
        <option value="bitcoin">Bitcoin (50%)</option>
        <option value="stock">Saham (15%)</option>
        <option value="bond">Obligasi (6%)</option>
        <option value="oil">Minyak (12%)</option>
        <option value="reit">REIT (9%)</option>
        <option value="sp500">S&P 500 (10%)</option>
      </select>

      <label class="text-sm font-semibold">Jumlah Investasi</label>
      <input id="amount" class="w-full p-3 rounded-lg border mb-3" type="number" placeholder="Cth: 1500000">

      <div id="calcFields">
        <label class="text-sm font-semibold">Durasi (tahun)</label>
        <input id="years" class="w-full p-3 rounded-lg border mb-3" type="number" value="5">

        <label class="text-sm font-semibold">Setoran Bulanan</label>
        <input id="monthly" class="w-full p-3 rounded-lg border mb-3" type="number" value="0">

        <label class="text-sm font-semibold">Custom Return (%)</label>
        <input id="customReturn" class="w-full p-3 rounded-lg border mb-3" type="number" placeholder="Kosongkan pakai rata-rata aset">

        <div class="flex gap-2">
          <button id="btnCalcDo" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg scale">Hitung</button>
          <button id="btnMonte" class="flex-1 py-3 bg-gray-100 rounded-lg scale small">Monte Carlo (100x)</button>
        </div>
      </div>

      <!-- Game and Challenge fields -->
      <div id="gameFields" class="hidden mt-3">
        <button id="btnGameInvest" class="w-full py-2 bg-green-600 text-white rounded mb-2">Investasikan (Game)</button>
        <button id="btnGameWithdraw" class="w-full py-2 bg-yellow-500 text-white rounded mb-2">Tarik (Game)</button>
        <button id="btnGameNext" class="w-full py-2 bg-blue-600 text-white rounded mb-2">Next Year (Game)</button>
      </div>

      <div id="challengeFields" class="hidden mt-3">
        <button id="btnChallengeInvest" class="w-full py-2 bg-purple-600 text-white rounded mb-2">Investasikan (Challenge)</button>
        <button id="btnChallengeNext" class="w-full py-2 bg-blue-600 text-white rounded mb-2">Next Year (Challenge)</button>
      </div>

      <!-- Pension module -->
      <hr class="my-4">
      <h3 class="font-semibold">üîí Mode Pensiun (Default standar)</h3>
      <div class="text-sm text-gray-700 mb-2">Target default: Rp 1.000.000.000 ‚Ä¢ Umur mulai: 30 ‚Ä¢ Umur pensiun: 60</div>

      <label class="text-sm">Aset untuk Pensiun</label>
      <select id="pensionAsset" class="w-full p-2 border rounded mb-2">
        <option value="gold">Emas (8%)</option>
        <option value="bitcoin">Bitcoin (50%)</option>
        <option value="stock">Saham (15%)</option>
        <option value="bond">Obligasi (6%)</option>
        <option value="oil">Minyak (12%)</option>
        <option value="reit">REIT (9%)</option>
        <option value="sp500" selected>S&P 500 (10%)</option>
        <option value="custom">Custom Return</option>
      </select>

      <label class="text-sm">Custom Return (%)</label>
      <input id="pensionCustomReturn" type="number" class="w-full p-2 border rounded mb-3" placeholder="Kosongkan bila tidak custom">

      <label class="text-sm">Umur saat ini</label>
      <input id="ageNow" type="number" value="30" class="w-full p-2 border rounded mb-2">
      <label class="text-sm">Umur pensiun</label>
      <input id="ageRetire" type="number" value="60" class="w-full p-2 border rounded mb-2">
      <label class="text-sm">Tabungan sekarang (Rp)</label>
      <input id="currentSavings" type="number" value="0" class="w-full p-2 border rounded mb-2">
      <label class="text-sm">Setoran bulanan (Rp)</label>
      <input id="pensionMonthly" type="number" value="1000000" class="w-full p-2 border rounded mb-2">
      <label class="text-sm">Target pensiun (Rp)</label>
      <input id="pensionTarget" type="number" value="1000000000" class="w-full p-2 border rounded mb-3">
      <div class="flex gap-2">
        <button id="btnPensionCalc" class="flex-1 py-2 bg-green-600 text-white rounded-lg scale">Hitung Pensiun</button>
        <button id="btnPensionShow" class="flex-1 py-2 bg-yellow-500 text-white rounded-lg scale">Tampilkan Proyeksi</button>
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="lg:col-span-2 glass p-6 shadow-xl card fade">
      <h2 class="text-xl font-bold mb-3">üìä Hasil</h2>

      <div id="result" class="bg-white/80 p-4 rounded-lg text-gray-700 mb-4">Belum ada hasil</div>

      <div id="yearList" class="hidden bg-white/80 p-4 rounded-lg text-gray-700 mb-4 max-h-48 overflow-auto"></div>

      <canvas id="chart" height="160" class="mb-6"></canvas>

      <h3 class="font-bold mb-2">Komposisi Portfolio</h3>
      <canvas id="pieChart" height="80"></canvas>
    </section>
  </div>

<script>
// Wait until DOM is loaded to avoid null element access
window.addEventListener('DOMContentLoaded', ()=>{
  // Helper
  const rp = n => 'Rp ' + Number(n).toLocaleString('id-ID');

  // DOM
  const btnCalc = document.getElementById('btnCalc');
  const btnGame = document.getElementById('btnGame');
  const btnChallenge = document.getElementById('btnChallenge');
  const btnCalcDo = document.getElementById('btnCalcDo');
  const btnMonte = document.getElementById('btnMonte');
  const btnPensionCalc = document.getElementById('btnPensionCalc');
  const btnPensionShow = document.getElementById('btnPensionShow');

  const assetEl = document.getElementById('asset');
  const amountEl = document.getElementById('amount');
  const yearsEl = document.getElementById('years');
  const monthlyEl = document.getElementById('monthly');
  const customReturnEl = document.getElementById('customReturn');

  const ageNowEl = document.getElementById('ageNow');
  const ageRetireEl = document.getElementById('ageRetire');
  const currentSavingsEl = document.getElementById('currentSavings');
  const pensionMonthlyEl = document.getElementById('pensionMonthly');
  const pensionTargetEl = document.getElementById('pensionTarget');
  const pensionAssetEl = document.getElementById('pensionAsset');
  const pensionCustomReturnEl = document.getElementById('pensionCustomReturn');

  const resultEl = document.getElementById('result');
  const yearListEl = document.getElementById('yearList');
  const chartCanvas = document.getElementById('chart');
  const pieCanvas = document.getElementById('pieChart');

  // State
  let mode = 'calc';
  let chart = null, pieChart = null;
  const assets = {
    gold:{avg:8,range:[-5,20]}, bitcoin:{avg:50,range:[-60,200]}, stock:{avg:15,range:[-30,50]},
    bond:{avg:6,range:[-2,12]}, oil:{avg:12,range:[-40,60]}, reit:{avg:9,range:[-20,25]}, sp500:{avg:10,range:[-25,40]}
  };
  let game = { balance:1000000, year:0, portfolio:{} };
  let challenge = { balance:1000000, year:0, portfolio:{}, target:20000000 };
  for(const k in assets){ game.portfolio[k]=0; challenge.portfolio[k]=0; }

  // Mode buttons wiring
  btnCalc.addEventListener('click', ()=>switchMode('calc'));
  btnGame.addEventListener('click', ()=>switchMode('game'));
  btnChallenge.addEventListener('click', ()=>switchMode('challenge'));

  function switchMode(m){
    mode=m;
    document.getElementById('calcFields').classList.toggle('hidden', m!=='calc');
    document.getElementById('gameFields').classList.toggle('hidden', m!=='game');
    document.getElementById('challengeFields').classList.toggle('hidden', m!=='challenge');
    yearListEl.classList.add('hidden');
  }

  // ------------------ Calculator Year-by-Year ------------------
  function calc(){
    const amt = Number(amountEl.value) || 0;
    const yrs = Math.max(0, Number(yearsEl.value) || 0);
    const monthly = Number(monthlyEl.value) || 0;
    const assetKey = assetEl.value;
    const custom = Number(customReturnEl.value);
    const r = (!Number.isNaN(custom) && custom !== 0) ? custom : assets[assetKey].avg;

    let values = [amt];
    let details = '';
    let current = amt;

    for(let i=1;i<=yrs;i++){
      // compound monthly contributions into annual
      current = (current + monthly*12) * (1 + r/100);
      values.push(current);
      details += `Tahun ${i}: <b>${rp(Math.floor(current))}</b><br>`;
    }

    yearListEl.innerHTML = details || '<i>Tidak ada data tahunan</i>';
    yearListEl.classList.remove('hidden');
    resultEl.innerHTML = `Nilai akhir setelah ${yrs} tahun: <b>${rp(Math.floor(current))}</b>`;
    updateChart(Array.from({length: values.length}, (_,i)=>i), values);
  }
  btnCalcDo.addEventListener('click', calc);

  // ------------------ Monte Carlo (100 simulations, 3-line output) ------------------
  btnMonte.addEventListener('click', ()=>runMonteCarlo(100));
  function runMonteCarlo(nSim=100){
    const amt = Number(amountEl.value) || 0;
    const yrs = Math.max(0, Number(yearsEl.value) || 0);
    const monthly = Number(monthlyEl.value) || 0;
    const assetKey = assetEl.value;
    const custom = Number(customReturnEl.value);
    const base = (!Number.isNaN(custom) && custom !== 0) ? custom : assets[assetKey].avg;
    const [minR, maxR] = assets[assetKey].range;

    // store series for each simulation
    const sims = [];
    for(let s=0;s<nSim;s++){
      let cur = amt;
      const series=[cur];
      for(let y=1;y<=yrs;y++){
        // draw annual return uniformly between minR and maxR centered on base
        const rRand = minR + Math.random()*(maxR-minR);
        // small bias towards base
        const r = (rRand + base)/2;
        cur = (cur + monthly*12) * (1 + r/100);
        series.push(cur);
      }
      sims.push(series);
    }

    // compute per-year percentile series: worst(min), median, best(max)
    const worst = [], median = [], best = [];
    for(let year=0; year<=yrs; year++){
      const vals = sims.map(s=> s[year] );
      vals.sort((a,b)=>a-b);
      worst.push(vals[0]);
      median.push(vals[Math.floor(vals.length/2)]);
      best.push(vals[vals.length-1]);
    }

    // display
    resultEl.innerHTML = `Monte Carlo (${nSim} simulasi):<br>Nilai median akhir: <b>${rp(Math.floor(median[median.length-1]||0))}</b>`;
    yearListEl.innerHTML = `Tahun per tahun (median):<br>` + median.map((v,i)=> `T${i}: ${rp(Math.floor(v))}`).join('<br>');
    yearListEl.classList.remove('hidden');

    // update chart with 3 lines
    if(chart) chart.destroy();
    chart = new Chart(chartCanvas.getContext('2d'),{
      type:'line', data:{ labels: Array.from({length: median.length}, (_,i)=>i), datasets:[
        { label:'Worst', data: worst.map(Math.floor), borderColor:'#ef4444', tension:0.2, fill:false },
        { label:'Median', data: median.map(Math.floor), borderColor:'#f59e0b', tension:0.2, fill:false },
        { label:'Best', data: best.map(Math.floor), borderColor:'#10b981', tension:0.2, fill:false }
      ]}, options:{responsive:true}
    });
  }

  // ------------------ Pension Module ------------------
  btnPensionCalc.addEventListener('click', ()=>{
    const now = Number(ageNowEl.value) || 30;
    const retire = Number(ageRetireEl.value) || 60;
    const years = Math.max(0, retire - now);
    const current = Number(currentSavingsEl.value) || 0;
    const monthly = Number(pensionMonthlyEl.value) || 0;
    const target = Number(pensionTargetEl.value) || 1000000000;

    const assetKey = pensionAssetEl.value;
    const customR = Number(pensionCustomReturnEl.value);

    let r;
    if(assetKey === 'custom' && !Number.isNaN(customR) && customR > 0){ r = customR; }
    else { r = assets[assetKey].avg; }

    let values=[current]; let cur=current;
    for(let y=1;y<=years;y++){
      cur = (cur + monthly*12) * (1 + r/100);
      values.push(cur);
    }

    const final = Math.floor(values[values.length-1]||0);
    const achieved = final >= target;
    resultEl.innerHTML = `Proyeksi pensiun (${assetKey}) dalam ${years} tahun: <b>${rp(final)}</b> ‚Äî ${achieved ? '<span style="color:green">Target tercapai ‚úÖ</span>' : '<span style="color:red">Belum tercapai ‚ùå</span>'}`;

    yearListEl.innerHTML = values.map((v,i)=>`T${i}: ${rp(Math.floor(v))}`).join('<br>');
    yearListEl.classList.remove('hidden');
    updateChart(Array.from({length: values.length}, (_,i)=>i), values);
  });

  btnPensionShow.addEventListener('click', ()=>{
    // show interactive pension inputs in result area
    resultEl.innerHTML = `Masukkan data lalu klik "Hitung Pensiun". Target default: Rp 1.000.000.000`;
  });

  // ------------------ Pie chart update ------------------
  function updatePie(obj){
    const labels = Object.keys(obj.portfolio);
    const values = labels.map(k=> Math.floor(obj.portfolio[k] || 0));
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(pieCanvas.getContext('2d'),{ type:'pie', data:{ labels, datasets:[{ data: values }] }, options:{responsive:true} });
  }

  // init empty chart and pie
  function updateChart(labels,data){ if(chart) chart.destroy(); chart = new Chart(chartCanvas.getContext('2d'),{ type:'line', data:{ labels, datasets:[{ label:'Nilai', data: data.map(Math.floor), borderColor:'#4f46e5', tension:0.2 }] }, options:{responsive:true} }); }
  updateChart([0],[1000000]); updatePie(game); switchMode('calc');

  // --- Game Logic ---
  function gameInvest(){
    const amt = Number(amountEl.value) || 0;
    const assetKey = assetEl.value;
    if(amt <= 0) return alert('Masukkan nominal!');
    if(amt > game.balance) return alert('Saldo tidak cukup');
    game.balance -= amt;
    game.portfolio[assetKey] += amt;
    resultEl.innerHTML = `Game: Invest ${rp(amt)} ke ${assetKey}.<br>Saldo sekarang: ${rp(game.balance)}`;
    updatePie(game);
  }

  function gameWithdraw(){
    const assetKey = assetEl.value;
    const val = game.portfolio[assetKey] || 0;
    if(val <= 0) return alert('Tidak ada dana pada aset ini');
    game.portfolio[assetKey] = 0;
    game.balance += val;
    resultEl.innerHTML = `Game: Tarik saldo dari ${assetKey}: ${rp(val)}<br>Saldo: ${rp(game.balance)}`;
    updatePie(game);
  }

  function gameNext(){
    game.year++;
    for(const k in game.portfolio){
      const base = assets[k].avg;
      const [minR, maxR] = assets[k].range;
      const rRand = minR + Math.random() * (maxR - minR);
      const r = (rRand + base) / 2;
      game.portfolio[k] *= (1 + r/100);
    }
    resultEl.innerHTML = `Tahun ${game.year}: portofolio bertumbuh.`;
    updatePie(game);
  }

  // wire game buttons
  document.getElementById('btnGameInvest').addEventListener('click', gameInvest);
  document.getElementById('btnGameWithdraw').addEventListener('click', gameWithdraw);
  document.getElementById('btnGameNext').addEventListener('click', gameNext);

  // --- Challenge Logic Simplified ---
  function challengeInvest(){
    const amt = Number(amountEl.value) || 0;
    const assetKey = assetEl.value;
    if(amt<=0) return alert('Masukkan nominal investasi!');
    if(amt > challenge.balance) return alert('Saldo challenge tidak cukup');
    challenge.balance -= amt;
    challenge.portfolio[assetKey] += amt;
    resultEl.innerHTML = `Challenge: Invest ${rp(amt)} ke ${assetKey}.`;
    updatePie(challenge);
  }

  function challengeNext(){
    challenge.year++;
    for(const k in challenge.portfolio){
      const base = assets[k].avg;
      const [minR, maxR] = assets[k].range;
      const rRand = minR + Math.random() * (maxR - minR);
      const r = (rRand + base) / 2;
      challenge.portfolio[k] *= (1 + r/100);
    }
    const total = Object.values(challenge.portfolio).reduce((a,b)=>a+b,0) + challenge.balance;
    resultEl.innerHTML = `Challenge Tahun ${challenge.year}. Total: ${rp(Math.floor(total))}. Target: ${rp(challenge.target)}`;
    updatePie(challenge);
  }

  // wire challenge buttons
  document.getElementById('btnChallengeInvest').addEventListener('click', challengeInvest);
  document.getElementById('btnChallengeNext').addEventListener('click', challengeNext);

}); // end DOMContentLoaded
</script>
</body>
</html>
